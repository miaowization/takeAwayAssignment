version: 2.1
jobs:
  build:
    docker:
      - image: python:3.8.5
    steps:
      - checkout
      - run:
          name: Install Google Chrome and chromedriver
          command: |
            wget -O google-chrome-latest.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
            dpkg -i google-chrome-latest.deb

      - run:
          name: Install Firefox and geckodriver
          command: |
            apt-add-repository ppa:qameta/allure
            apt-get update
            apt-get install firefox

      - run:
          name: Install Allure
          command: |
            curl -o allure-2.7.0.tgz -Ls https://dl.bintray.com/qameta/generic/io/qameta/allure/allure/2.7.0/allure-2.7.0.tgz
            tar -zxvf allure-2.7.0.tgz -C /opt/
            ln -s /opt/allure-2.7.0/bin/allure /usr/bin/allure
            rm -rf allure-2.7.0.tgz
            allure --version
      - run:
          name: Install tools
          command: python -m pip install --upgrade pip setuptools wheel
      - run:
          name: Install requirements
          command: pip install -r requirements.txt

      - run:
          name: Run tests
          command: |
            pip install pytest
            pip install pytest-cov
            pytest tests --headless True --browser 'Firefox' --alluredir=tmp/my_allure_results
      - run:
          name: Generate test report
          command: allure generate tmp/my_allure_results
      - store_artifacts:
          path: ./allure-report